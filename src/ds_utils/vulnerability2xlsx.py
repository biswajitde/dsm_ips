# -*- coding: utf-8 -*-
# Copyright Â© 2018 Trend Micro Incorporated.  All rights reserved.
"""Conver intrusion prevention vulnerability report to xlsx format"""

import csv
import re
import xlsxwriter

def parse(csv_file, xlsx_file):
    """
    parse csv file contain intrusion prevention vulnerability report
    convert content into xlsx file with chart
     Args:
        csv_file (str): which csv file to parse, include file path and file name
        xlsx_file (str): where xlsx would create, include file path and file name

    """
    #Summary info
    description = []

    #Severity info
    severity_pattern = re.compile(r'(.+):.+\((\d+)/(\d+)\)')
    severity_count = {}

    #Protected info
    protected_cve_list_title = r'CVEs already protected on Hosts'
    unprotected_cve_list_title = r'CVEs that can be protected on Hosts'
    title_patterns = re.compile('({})|({})'.format(protected_cve_list_title, unprotected_cve_list_title))
    protected_list = []
    unprotected_list = []
    host_list = [
        protected_list,
        unprotected_list
    ]

    #Help url
    action_pattern = re.compile('\[(.+)\: (.+)\]')
    action_list = []

    #Parse csv file
    with open(csv_file, 'r', newline='') as csv_file:
        rows = csv.reader(csv_file, quotechar='"', delimiter=',', skipinitialspace=True)
        for index, row in enumerate(rows):
            if not row:
                continue

            if row[0].startswith('#'):
                description.append(row[0].replace('# ', ''))
                continue

            search = severity_pattern.search(row[0])
            if search:
                severity_count[search.group(1)] = [int(search.group(2)), int(search.group(3)) - int(search.group(2))]
            if re.search('CVEs that can be protected \(Based on severity level\)', row[0]):
                break

        current_pattern = -1
        for index, row in enumerate(rows):
            if not row or re.match('None', row[0]):
                continue

            search = action_pattern.search(row[0])
            if search:
                action_list.append((search.group(1), search.group(2)))

            search = title_patterns.search(row[0])
            if search:
                current_pattern = next((i for i, x in enumerate(search.groups()) if x), None)
                continue

            if current_pattern == -1:
                continue
            host_list[current_pattern].append(row)

    #Write xlsx file
    workbook = xlsxwriter.Workbook(xlsx_file)
    summary_worksheet = workbook.add_worksheet('Summary')
    rawdata_worksheet = workbook.add_worksheet('Data')
    protected_list_worksheet = workbook.add_worksheet('CVEs already protected')
    unprotected_list_worksheet = workbook.add_worksheet('CVEs that can be protected')

    #Rawdata worksheet
    data = [['Severity level'], ['Protected'], ['Unprotected']]
    for key,values in severity_count.items():
        data[0].append(key)
        for i in range(len(values)):
            data[i+1].append(values[i])
    rawdata_worksheet.write_column('A1', data[0], workbook.add_format({'bold': True}))
    rawdata_worksheet.write_column('B1', data[1])
    rawdata_worksheet.write_column('C1', data[2])

    #Protected list worksheet
    protected_list_worksheet.write_row(0, 0, [protected_cve_list_title])
    for index, row in enumerate(protected_list):
        protected_list_worksheet.write_row(index+1, 0, row, workbook.add_format({'bold': index == 0}))

    #Unprotected list worksheet
    unprotected_list_worksheet.write_row(0, 0, [unprotected_cve_list_title])
    for index, row in enumerate(unprotected_list):
        unprotected_list_worksheet.write_row(index+1, 0, row, workbook.add_format({'bold': index == 0}))

    #Summary worksheet
    chart = workbook.add_chart({'type': 'column', 'subtype': 'percent_stacked'})
    chart.add_series({
        'name': '=Data!$B$1',
        'categories': '=Data!$A$2:$A$' + str(len(data[0])),
        'values':     '=Data!$B$2:$B$' + str(len(data[0])),
        'fill':   {'color': '#21BC3B'}
    })
    chart.add_series({
        'name': '=Data!$C$1',
        'categories': '=Data!$A$2:$A$' + str(len(data[0])),
        'values':     '=Data!$C$2:$C$' + str(len(data[0])),
        'fill':   {'color': '#C22828'}
    })
    chart.set_title ({'name': 'Third-party scan results'})
    chart.set_x_axis({
        'name': 'Severity level',
    })

    chart.set_y_axis({
        'major_unit' : 0.2,
        'min' : 0,
        'max' : 1
    })
    summary_worksheet.insert_chart('A1', chart)
    summary_worksheet.write_column('A16', description)
    for index, (text, url) in enumerate(action_list):
        summary_worksheet.write_url('A'+str(index+20), url, string = text)
    summary_worksheet.activate()

    workbook.close()